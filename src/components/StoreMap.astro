---
import stores from "../data/stores.json";

// åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’JSONæ–‡å­—åˆ—ã¨ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã«æ¸¡ã™
const storesJson = JSON.stringify(stores);
---

<div class="store-map-component">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     
    <div id="embedded-map"></div>
    
    <!-- ãƒ‡ãƒ¼ã‚¿ã‚’HTMLè¦ç´ ã«åŸ‹ã‚è¾¼ã‚€ -->
    <div id="embedded-map-data" data-stores={storesJson} style="display:none;"></div>

    <!-- Leaflet JS -->
    <script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script is:inline>
        (function() {
            // ãƒ‡ãƒ¼ã‚¿å–å¾—
            const dataElement = document.getElementById('embedded-map-data');
            if (!dataElement) return;
            
            const stores = JSON.parse(dataElement.dataset.stores);

            // åœ°å›³ã®åˆæœŸåŒ– (æ²–ç¸„æœ¬å³¶ä¸­å¿ƒ)
            const map = L.map('embedded-map').setView([26.35, 127.8], 9);

            // åœ°å›³ã‚¿ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // å„åº—èˆ—ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            stores.forEach(store => {
                if (store.lat && store.lng) {
                    const marker = L.marker([store.lat, store.lng]).addTo(map);
                    
                    const popupContent = `
                        <div class="store-popup-embed">
                            <img src="${store.logo}" alt="${store.name}" style="width:40px; height:40px; border-radius:50%; object-fit:contain; display:block; margin:0 auto 5px auto;">
                            <h3 style="font-size:1rem; margin:0 0 5px 0; text-align:center;">${store.name}</h3>
                            <div style="text-align:center;">
                                <a href="/stores/${store.id}" style="color:#ff7f00; font-weight:bold; text-decoration:none;">è©³ç´° â†’</a>
                            </div>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                }
            });

            // ç¾åœ¨åœ°å–å¾—ãƒœã‚¿ãƒ³
            const locateControl = L.Control.extend({
                options: { position: 'topleft' },
                onAdd: function(map) {
                    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                    container.style.backgroundColor = 'white';
                    container.style.width = '30px';
                    container.style.height = '30px';
                    container.style.cursor = 'pointer';
                    container.style.display = 'flex';
                    container.style.alignItems = 'center';
                    container.style.justifyContent = 'center';
                    container.title = "ç¾åœ¨åœ°ã‚’è¡¨ç¤º";
                    container.innerHTML = 'ğŸ“';
                    
                    container.onclick = function(e){
                        e.preventDefault();
                        e.stopPropagation();
                        map.locate({setView: true, maxZoom: 13});
                    }
                    return container;
                }
            });
            map.addControl(new locateControl());

            map.on('locationfound', function(e) {
                L.circle(e.latlng, {
                    radius: e.accuracy / 2,
                    color: '#4285F4',
                    fillColor: '#4285F4',
                    fillOpacity: 0.2
                }).addTo(map);
                L.marker(e.latlng).addTo(map).bindPopup("ç¾åœ¨åœ°").openPopup();
            });
        })();
    </script>
</div>

<style>
    #embedded-map {
        width: 100%;
        height: 400px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        z-index: 1;
        border: 1px solid var(--color-border);
    }
    
    /* Leafletã®ã‚¹ã‚¿ã‚¤ãƒ«ä¸Šæ›¸ã */
    .leaflet-popup-content-wrapper {
        border-radius: 8px;
        padding: 0;
    }
    .leaflet-popup-content {
        margin: 10px;
        width: 160px !important;
    }
</style>
