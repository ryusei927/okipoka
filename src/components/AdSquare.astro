---
// src/components/AdSquare.astro
import adsData from '../data/ads.json';

// 型定義
interface Ad {
  id: string;
  name: string;
  url: string;
  images: {
    square: string;
    banner: string;
  };
}

// ★★★ 正方形画像のみを持つ広告を抽出（バナーがないもの） ★★★
const squareAds = adsData.filter((ad: Ad) => !ad.images.banner || ad.images.banner.trim() === '');

function shuffleArray(array: Ad[]): Ad[] {
  let currentIndex = array.length, randomIndex;
  while (currentIndex !== 0) {
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;
    [array[currentIndex], array[randomIndex]] = [
      array[randomIndex], array[currentIndex]];
  }
  return array;
}

// 正方形広告の中から2つだけランダムで選ぶ
const shuffledAds = shuffleArray(squareAds);
const selectedAds = shuffledAds.slice(0, 2);
---

{/* 広告が1つでも存在する場合のみ表示する */}
{selectedAds.length > 0 && (
  <section class="ad-section">
    <div class="ad-container-wrapper" role="region" aria-labelledby="ad-label">
      <div id="ad-label" class="ad-label">広告</div>
      <div class="ad-container">
        {selectedAds.map(ad => (
          <a href={ad.url} target="_blank" rel="noopener noreferrer" class="ad-item ad-item--square">
            <img src={ad.images.square} alt={ad.name} loading="lazy" />
          </a>
        ))}
      </div>
    </div>
  </section>
)}

<style>
  .ad-section { margin: 3.2rem 0; }
  .ad-container-wrapper {
    position: relative;
    padding-top: 1.6rem;
    border-top: 1px solid #efefef;
  }
  .ad-label {
    position: absolute;
    top: -0.9rem;
    left: 0.5rem;
    right: auto;
    text-align: left;
    font-size: 1.1rem;
    color: #888;
    background: var(--color-background, #fafafa);
    border: 1px solid #e5e5e5;
    padding: 2px 6px;
    line-height: 1.2;
  }
  .ad-container { 
    display: grid; 
    grid-template-columns: repeat(2, 1fr); 
    gap: 12px; 
  }
  /* PC表示時は広告を小さく */
  @media (min-width: 768px) {
    .ad-container {
      max-width: 850px;
      margin: 0 auto;
      gap: 10px;
    }
  }
  @media (max-width: 360px) {
    .ad-container {
      grid-template-columns: 1fr;
    }
  }
  .ad-item {
    display: block;
    overflow: hidden;
    border: 1px solid #e5e5e5;
    background: #fff;
    transition: transform 0.2s ease;
    max-width: 100%;
  }
  /* 正方形用のスタイル */
  .ad-item--square {
    aspect-ratio: 1 / 1;
    width: 100%;
    height: auto;
  }
  .ad-item:hover { transform: translateY(-2px); }
  .ad-item:focus-visible { outline: 2px dotted #bbb; outline-offset: 2px; }
  .ad-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
</style>