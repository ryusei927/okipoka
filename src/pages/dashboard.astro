---
// src/pages/dashboard.astro
---
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | OKIPOKA</title>

  <style is:global>
:root{
  /* Brand & surfaces */
  --pri:#ff7f00; --pri2:#e66f00;
  --bg:#f5f7fb;                /* å¤–å´ã®æ¿ƒã„èƒŒæ™¯ */
  --surface:#ffffff;
  /* ã‚«ãƒ¼ãƒ‰ */
  --border:#e5e7eb;            /* æ ç·š */
  --ink:#111827;               /* æœ¬æ–‡ */
  --muted:#64748b;             /* è£œåŠ©ãƒ†ã‚­ã‚¹ãƒˆ */
  --danger:#ef4444;
  --danger2:#dc2626;
  --radius:16px;               /* è§’ä¸¸ã¯å¤§ãã‚ */
  --shadow:0 6px 16px rgba(17,24,39,.08);
  --shadow-sm:0 4px 10px rgba(17,24,39,.06);
}

*{ box-sizing:border-box; }

/* ===== ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ã‚¹ãƒãƒ›åŸºæº–ã«ï¼‰ ===== */
html,body{ height:100%; }
body{
  margin:0; background:var(--bg); color:var(--ink);
  font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans JP',Helvetica,Arial,sans-serif;
  line-height:1.6;
  font-size:16px;
}

main{ max-width:640px; margin:0 auto; padding:24px 16px 64px; }

/* ä¸Šéƒ¨ã®ãƒ­ã‚°ã‚¤ãƒ³è¡¨ç¤ºã‚«ãƒ¼ãƒ‰ */
#user-info{
  background:var(--surface); border:1.5px solid var(--border);
  border-radius:var(--radius); box-shadow:var(--shadow-sm);
  margin:16px auto 20px; padding:14px 16px;
  display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
  max-width:640px;
}
#user-info p{
  margin:0; font-weight:700; font-size:16px;
  display:flex; align-items:center; gap:8px; flex-wrap:wrap;
  /* ãƒãƒƒã‚¸ã¨ãƒ†ã‚­ã‚¹ãƒˆã®æ•´åˆ— */
}
#master-badge{
  background:#ff6b6b;
  color:#fff !important;          /* æ—§ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã®colorã‚’ä¸Šæ›¸ã */
  padding:6px 10px;
  border-radius:999px;
  font-size:13px;
  font-weight:800;
  line-height:1;
  /* ã‚¯ãƒªãƒƒãƒ—é˜²æ­¢ */
  display:inline-flex;            /* é«˜ã•ãŒé€”åˆ‡ã‚Œãªã„ã‚ˆã†ã« */
  align-items:center;
  white-space:nowrap;             /* æ”¹è¡Œã§æ¬ ã‘ãªã„ */
}

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ */
.dashboard-section{
  background:var(--surface);
  border:1.5px solid var(--border);
  border-radius:var(--radius); box-shadow:var(--shadow);
  margin:16px auto; padding:18px 16px;
  max-width:640px;
}

h1,h2{ margin:0 0 16px; font-weight:900; text-align:center; }
h1{ font-size:22px; }
h2{ font-size:20px; color:#0f172a; }

/* ãƒ©ãƒ™ãƒ« & ãƒ˜ãƒ«ãƒ— */
label{ display:block; color:var(--muted); font-weight:700; font-size:16px; margin:14px 0 8px; }

/* ===== å…¥åŠ›UIï¼ˆå¤§ãããƒ»æŠ¼ã—ã‚„ã™ãï¼‰ ===== */
select,input,textarea{
  width:100%;
  appearance:none; -webkit-appearance:none; outline:0;
  border:2px solid var(--border); background:#fff; color:var(--ink);
  border-radius:16px; padding:18px 18px; font-size:18px; line-height:1.35;
  min-height:58px;
  /* bigger tap target */
  transition:border-color .15s, box-shadow .15s, transform .1s;
}
input[type="time"], input[type="date"]{ min-height:58px; }
textarea{ min-height:140px; }
select{
  background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath d='M6 8l4 4 4-4' stroke='%2364748b' stroke-width='1.8' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
  background-repeat:no-repeat;
  background-position:right 14px center; background-size:20px 20px; padding-right:52px;
}
select:focus,input:focus,textarea:focus{
  border-color:var(--pri);
  box-shadow:0 0 0 4px color-mix(in srgb, var(--pri) 18%, transparent);
  transform:translateY(-1px);
}

/* é€ä¿¡ãƒœã‚¿ãƒ³ï¼ˆtype=submit ã¯æ—¢å­˜HTMLãã®ã¾ã¾ï¼‰ */
button[type="submit"]{
  width:100%; max-width:520px; display:inline-flex; justify-content:center; align-items:center;
  gap:.6rem; padding:18px 20px; border-radius:14px; border:0; cursor:pointer;
  background:linear-gradient(135deg,var(--pri),var(--pri2)); color:#fff; font-weight:900; font-size:18px;
  margin-top:12px; box-shadow:var(--shadow-sm); transition:transform .1s, filter .15s;
}
button[type="submit"]:hover{ transform:translateY(-1px); }
button[type="submit"]:active{ transform:translateY(0); }

/* æ±ç”¨ãƒœã‚¿ãƒ³ï¼ˆãƒ›ãƒ¼ãƒ /ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ/ç·¨é›†/å‰Šé™¤ï¼‰ */
#home-btn, #logout-btn, .edit-btn, .delete-btn{
  display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
  padding:14px 16px; border-radius:12px; border:0; font-weight:900; cursor:pointer;
  box-shadow:var(--shadow-sm); font-size:16px;
}
#home-btn{ background:#10b981; color:#fff; }
#home-btn:hover{ filter:brightness(1.05); }
#logout-btn{ background:#6b7280; color:#fff; }
#logout-btn:hover{ filter:brightness(1.05); }
.edit-btn{ background:#1e90ff; color:#fff; min-width:92px; }
.edit-btn:hover{ background:#1c86ee; }
.delete-btn{ background:var(--danger); color:#fff; min-width:92px; }
.delete-btn:hover{ background:var(--danger2); }

/* ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¸€è¦§ï¼‰ */
.tournaments-container{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
table{ width:100%; border-collapse:collapse; margin-top:12px; background:#fff; border-radius:14px; overflow:hidden; box-shadow:var(--shadow-sm); font-size:16px; }
th{ background:#f1f5f9; color:#111827; font-weight:800; text-align:left; padding:14px; font-size:13px; letter-spacing:.02em; }
td{ padding:14px; border-bottom:1px solid var(--border); }
tr:last-child td{ border-bottom:0; }
tbody tr:hover{ background:#fafbff; }

/* ç©ºçŠ¶æ…‹/ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
.loading,.empty-state{ text-align:center; color:var(--muted); padding:22px; }
.empty-state{ border:2px dashed var(--border); border-radius:14px; background:#f8fafc; }

/* === ç™»éŒ²æ¸ˆã¿ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆï¼šã‚«ãƒ¼ãƒ‰è¡¨ç¤º === */
#tournament-list, #tournament-list-store{ display:block; }
.tournament-card{
  background:#fff; border:1.5px solid var(--border); border-radius:14px;
  box-shadow:var(--shadow-sm); padding:16px; margin-bottom:14px;
}
.tournament-header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:6px; }
.tournament-header h3{ margin:0; font-size:17px; font-weight:800; color:#111827; line-height:1.3; }
.tournament-header .fee{ font-weight:900; font-size:16px; color:#111827; white-space:nowrap; }
.tournament-meta{ font-size:14px; color:var(--muted); line-height:1.5; display:grid; grid-template-columns: 1fr 1fr; gap:6px 12px; }
.tournament-meta div strong{ color:#111827; font-weight:800; margin-right:4px; }
.tournament-card .edit-btn, .tournament-card .delete-btn{ 
  margin-top:12px; border:0; border-radius:10px; padding:10px 14px; 
  font-weight:800; font-size:15px; color:#fff;
  cursor:pointer;
  display:inline-flex; align-items:center; justify-content:center;
}
.tournament-card .edit-btn{ background:#1e90ff; }
.tournament-card .edit-btn:hover{ background:#1c86ee; }
.tournament-card .delete-btn{ background:var(--danger); }
.tournament-card .delete-btn:hover{ background:var(--danger2); }



/* ===== ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸Šã§å°‘ã—å¼•ãç· ã‚ ===== */
@media (min-width:768px){
  body{ font-size:16px; }
  main{ max-width:760px; padding:28px 0 64px; }
  .dashboard-section{ max-width:720px; margin:24px auto; padding:22px; }
  h1{ font-size:21px; }
  h2{ font-size:19px; }
  select,input,textarea{ font-size:16px; min-height:50px; }
  button[type="submit"]{ width:auto; min-width:200px; padding:14px 18px; }
}

/* å¤§å‰æ¼”å‡º */
@keyframes rainbow-flash {
  0% { background-color: var(--bg); }
  20% { background-color: #fff0f0; }
  40% { background-color: #f0fff0; }
  60% { background-color: #f0f0ff; }
  80% { background-color: #fff0ff; }
  100% { background-color: var(--bg); }
}
.celebration-mode {
  animation: rainbow-flash 0.5s infinite;
}
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.85); z-index: 9999;
  display: flex; align-items: center; justify-content: center;
  backdrop-filter: blur(5px);
}
.modal-content {
  background: #fff; border: 4px solid #ff0000; border-radius: 20px;
  padding: 30px; max-width: 90%; width: 400px; text-align: center;
  box-shadow: 0 0 50px rgba(255,0,0,0.5);
  animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  position: relative;
  overflow: hidden;
}
@keyframes popIn {
  from { transform: scale(0.5); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
.modal-title {
  color: #d32f2f; font-size: 24px; margin-bottom: 20px;
  text-shadow: 2px 2px 0 #ffeb3b;
}
.modal-result {
  font-size: 28px; font-weight: 900; margin: 20px 0;
  line-height: 1.4; color: #111827;
}
#modal-close-btn {
  background: #ff0000; color: #fff; border: none;
  padding: 15px 30px; font-size: 18px; font-weight: bold;
  border-radius: 50px; cursor: pointer;
  box-shadow: 0 4px 0 #b71c1c;
  transition: transform 0.1s;
}
#modal-close-btn:active { transform: translateY(4px); box-shadow: none; }

/* æ¿€ã—ã„ç‚¹æ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¤§å‰ç”¨ãªã©ï¼‰ */
@keyframes flash-red {
  0%, 100% { background-color: #fff; }
  50% { background-color: #ffcccc; }
}
.modal-flash { animation: flash-red 0.2s infinite; }
  </style>
</head>
<body>
  <main>
    <!-- ãƒ¤ãƒ‰ãƒ³å ã„ï¼ˆã‚¤ã‚¿ã‚ºãƒ©æ©Ÿèƒ½ï¼‰ -->
    <div id="yadon-uranai" style="text-align:center; margin-bottom:20px; cursor:pointer; background:#fff9c4; padding:16px; border-radius:16px; border:3px dashed #ff0000; box-shadow:0 4px 10px rgba(17,24,39,.06);">
        <h3 style="margin:0 0 8px; font-size:20px; font-weight:900; color:#d32f2f; background:yellow; display:inline-block; padding:4px 8px; transform:rotate(-2deg);">ãƒ¤ãƒ‰ãƒ³å ã„</h3>
        <br>
        <img src="/images/yadon.jpg" alt="ãƒ¤ãƒ‰ãƒ³" style="width:120px; height:120px; object-fit:cover; border-radius:16px; border:4px solid #ff0000; margin-bottom:12px; margin-top:8px;">
        <br>
        <div style="background:#ff0000; color:#fff; font-weight:900; padding:12px 24px; border-radius:999px; display:inline-block; font-size:20px; box-shadow:0 4px 0 #b71c1c; animation: pulse 0.8s infinite;">
            ğŸ‘‰ ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ ğŸ‘ˆ
        </div>
        <p id="yadon-result" style="font-weight:bold; color:#111827; margin:12px 0 0; font-size:12px; opacity:0.7;">â€»å®Œå…¨ç„¡æ–™ â€»åŠ¹æœã«ã¯å€‹äººå·®ãŒã‚ã‚Šã¾ã™</p>
    </div>

    <div id="user-info">
      <p><span id="user-email"></span>ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­ <span id="master-badge" class="badge-master" style="display:none">ç®¡ç†è€…</span></p>
      <div style="display: flex; gap: 8px;">
        <button id="home-btn" style="background: #10b981; color: #fff;">TOP</button>
        <button id="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>
    <div id="dashboard-container"><p style="text-align:center;">èª­ã¿è¾¼ã¿ä¸­...</p></div>
  </main>

  <!-- å ã„çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="yadon-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <h2 class="modal-title">ğŸ”® é‹å‘½ã®å•“ç¤º ğŸ”®</h2>
      <div id="modal-result-text" class="modal-result"></div>
      <button id="modal-close-btn">é‹å‘½ã‚’å—ã‘å…¥ã‚Œã‚‹</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, doc, addDoc, serverTimestamp, deleteDoc, orderBy, getDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    
const firebaseConfig = {
  apiKey: "AIzaSyB8q6HLBGi_DWmrvkGCaWK_B6EeP7D--wo",
  authDomain: "okipoka-v2.firebaseapp.com",
  projectId: "okipoka-v2",
  storageBucket: "okipoka-v2.firebasestorage.app",
  messagingSenderId: "6256473895",
  appId: "1:6256473895:web:df644eaac108a218d59b02",
  measurementId: "G-JLC2569WN3"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const container = document.getElementById('dashboard-container');

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        document.getElementById('user-email').textContent = user.email;
        const roleDocSnap = await getDocs(query(collection(db, "roles"), where("__name__", "==", user.uid)));
        const isMaster = !roleDocSnap.empty && roleDocSnap.docs[0].data().isMaster === true;
        if (isMaster) {
            document.getElementById('master-badge').style.display = 'inline';
            renderMasterView();
        } else {
            alert('ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            window.location.href = '/login';
        }
      } else {
        window.location.href = '/login';
      }
    });

    document.getElementById('home-btn').addEventListener('click', () => window.location.href = '/');
    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

    // ãƒ¤ãƒ‰ãƒ³å ã„ãƒ­ã‚¸ãƒƒã‚¯
    const yadonResults = [
        "å¤§å‰ãƒ¤ã‚¡ãƒ³ï¼ä»Šæ—¥ã¯AAãŒé…ã‚‰ã‚Œã‚‹äºˆæ„Ÿ...",
        "ä¸­å‰ãƒ¤ã‚¡ãƒ³ã€‚ãƒªãƒãƒ¼ã§æ²ã‚Œã‚‹ã‹ã‚‚ï¼Ÿ",
        "å°å‰ãƒ¤ã‚¡ãƒ³ã€‚ãƒã‚±ãƒƒãƒˆãƒšã‚¢ã«ã¯æ°—ã‚’ã¤ã‘ã¦ã€‚",
        "å‰ãƒ¤ã‚¡ãƒ³ã€‚ãƒ–ãƒ©ãƒ•ã‚­ãƒ£ãƒƒãƒæˆåŠŸã®äºˆæ„Ÿï¼",
        "å‡¶ãƒ¤ã‚¡ãƒ³... ãƒãƒƒãƒ‰ãƒ“ãƒ¼ãƒˆã«æ³¨æ„ã€‚",
        "å¤§å‡¶ãƒ¤ã‚¡ãƒ³... ä»Šæ—¥ã¯ãƒ†ã‚£ãƒ«ãƒˆã—ãªã„ã‚ˆã†ã«å¯ã‚‹ã®ãŒä¸€ç•ªãƒ¤ã‚¡ãƒ³ã€‚"
    ];
    const yadonContainer = document.getElementById('yadon-uranai');
    // const yadonResultText = document.getElementById('yadon-result');
    const modal = document.getElementById('yadon-modal');
    const modalResultText = document.getElementById('modal-result-text');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalContent = document.querySelector('.modal-content');
    
    if(yadonContainer && modal){
        yadonContainer.addEventListener('click', () => {
            const random = Math.floor(Math.random() * yadonResults.length);
            const result = yadonResults[random];
            
            modalResultText.textContent = result;
            modal.style.display = 'flex';
            
            // å¤§å‰æ¼”å‡º
            if (result.includes("å¤§å‰")) {
                modalContent.classList.add('modal-flash');
                // ç´™å¹é›ª
                if (window.confetti) {
                    var duration = 3000;
                    var end = Date.now() + duration;

                    (function frame() {
                    var timeLeft = end - Date.now();

                    if (timeLeft <= 0) return;

                    window.confetti({
                        particleCount: 5,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0 },
                        colors: ['#ff7f00', '#ffd700', '#ff69b4'],
                        zIndex: 10000 // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ˆã‚Šä¸Š
                    });
                    window.confetti({
                        particleCount: 5,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1 },
                        colors: ['#ff7f00', '#ffd700', '#ff69b4'],
                        zIndex: 10000
                    });

                    requestAnimationFrame(frame);
                    }());
                }
                // èƒŒæ™¯ã‚­ãƒ©ã‚­ãƒ©
                document.body.classList.add('celebration-mode');
            } else {
                modalContent.classList.remove('modal-flash');
                document.body.classList.remove('celebration-mode');
            }
        });

        modalCloseBtn.addEventListener('click', () => {
            modal.style.display = 'none';
            document.body.classList.remove('celebration-mode');
        });
    }

    function getTodayStr(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    async function renderMasterView() {
      const storesSnapshot = await getDocs(collection(db, "stores"));
      const storeOptions = storesSnapshot.docs.map(d => `<option value="${d.id}">${d.data().name}</option>`).join('');
      
      container.innerHTML = `
        <section class="dashboard-section">
          <h2 id="form-title">ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆæ–°è¦ç™»éŒ²</h2>
          <form id="master-tournament-form">
            <input type="hidden" id="editing-id" value="">
            <div class="form-group"><label for="store-select">åº—èˆ—</label><select id="store-select" required>${storeOptions}</select></div>
            <div class="form-group"><label for="event-name">ã‚¤ãƒ™ãƒ³ãƒˆå</label><input type="text" id="event-name" required /></div>
            <div class="form-group"><label for="start-date">é–‹å‚¬æ—¥</label><input type="date" id="start-date" required /></div>
            <div class="form-group"><label for="start-time">é–‹å§‹æ™‚é–“</label><input type="time" id="start-time" required /></div>
            <div class="form-group"><label for="late-reg">ç· åˆ‡</label><input type="time" id="late-reg" /></div>
            <div class="form-group"><label for="event-type">ç¨®é¡</label><select id="event-type"><option value="ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ">ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ</option><option value="ã‚µãƒ†ãƒ©ã‚¤ãƒˆ">ã‚µãƒ†ãƒ©ã‚¤ãƒˆ</option><option value="ãã®ä»–">ãã®ä»–</option></select></div>
            <div class="form-group"><label for="buy-in">å‚åŠ è²»</label><input type="text" id="buy-in" required /></div>
            <div class="form-group"><label for="reentry-fee">ãƒªã‚¨ãƒ³ãƒˆãƒªãƒ¼</label><input type="text" id="reentry-fee" /></div>
            <div class="form-group"><label for="addon">ã‚¢ãƒ‰ã‚ªãƒ³</label><input type="text" id="addon" /></div>
            <div class="form-group"><label for="stack">ã‚¹ã‚¿ãƒƒã‚¯</label><input type="text" id="stack" /></div>
            <div class="form-group"><label for="prize">ãƒ—ãƒ©ã‚¤ã‚º</label><textarea id="prize" rows="3"></textarea></div>
            <div class="form-group"><label for="notes">å‚™è€ƒ</label><textarea id="notes" rows="4"></textarea></div>
            <button type="submit" id="submit-btn">ç™»éŒ²ã™ã‚‹</button>
            <button type="button" id="cancel-edit-btn" style="display:none; background: #6c757d; margin-top: 8px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </form>
        </section>
        <section class="dashboard-section">
            <h2>å…¨ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆä¸€è¦§</h2>
            <div class="form-group" style="margin-bottom: 20px;">
              <label for="filter-date">é–‹å‚¬æ—¥ã§çµã‚Šè¾¼ã¿</label>
              <input type="date" id="filter-date" />
              <button type="button" id="clear-filter-btn" style="margin-top: 8px; background: #6c757d; color: #fff; padding: 8px 16px; border: 0; border-radius: 8px; font-size: 14px; cursor: pointer;">å…¨ã¦è¡¨ç¤º</button>
            </div>
            <div class="tournaments-container"><div id="all-tournaments-list"></div></div>
        </section>


      `;

      document.getElementById('start-date').value = getTodayStr();
      document.getElementById('filter-date').value = getTodayStr();
      loadAllTournaments();

      document.getElementById('filter-date').addEventListener('change', loadAllTournaments);
      document.getElementById('clear-filter-btn').addEventListener('click', () => {
        document.getElementById('filter-date').value = '';
        loadAllTournaments();
      });

      const form = document.getElementById('master-tournament-form');
      form.addEventListener('submit', async e => {
        e.preventDefault();
        const editingId = document.getElementById('editing-id').value;
        const selectedStoreId = document.getElementById('store-select').value;
        const storeName = document.getElementById('store-select').options[document.getElementById('store-select').selectedIndex].text;
        
        const payload = {
          eventName: document.getElementById('event-name').value,
          startDate: document.getElementById('start-date').value,
          startTime: document.getElementById('start-time').value,
          lateReg: document.getElementById('late-reg').value,
          eventType: document.getElementById('event-type').value,
          buyIn: document.getElementById('buy-in').value,
          reentryFee: document.getElementById('reentry-fee').value,
          addon: document.getElementById('addon').value,
          stack: document.getElementById('stack').value,
          prize: document.getElementById('prize').value,
          notes: document.getElementById('notes').value,
          storeId: selectedStoreId,
          storeName: storeName
        };

        if (editingId) {
          await updateDoc(doc(db, "tournaments", editingId), payload);
          alert('æ›´æ–°ã—ã¾ã—ãŸï¼');
        } else {
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db, "tournaments"), payload);
          alert('ç™»éŒ²ã—ã¾ã—ãŸï¼');
        }
        resetForm();
        loadAllTournaments();
      });
      document.getElementById('cancel-edit-btn').addEventListener('click', () => {
        resetForm();
      });


    }

    function resetForm() {
        document.getElementById('master-tournament-form').reset();
        document.getElementById('editing-id').value = '';
        document.getElementById('form-title').textContent = 'ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆæ–°è¦ç™»éŒ²';
        document.getElementById('submit-btn').textContent = 'ç™»éŒ²ã™ã‚‹';
        document.getElementById('cancel-edit-btn').style.display = 'none';
        document.getElementById('start-date').value = getTodayStr();
    }

    async function loadAllTournaments() {
      const list = document.getElementById('all-tournaments-list');
      list.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
      const filterDate = document.getElementById('filter-date')?.value || '';
      const qAll = query(collection(db, "tournaments"), orderBy("createdAt", "desc"));
      const snapshot = await getDocs(qAll);
      let filteredDocs = snapshot.docs;
      if (filterDate) {
        filteredDocs = snapshot.docs.filter(d => d.data().startDate === filterDate);
      }
      if (filteredDocs.length === 0){ 
        const message = filterDate ? `${filterDate}ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“` : 'ç™»éŒ²ã•ã‚ŒãŸãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“';
        list.innerHTML = `<div class="empty-state">${message}</div>`; 
        return; 
      }
      list.innerHTML = filteredDocs.map(d => {
        const t = d.data();
        return `<div class="tournament-card">
            <div class="tournament-header"><h3>${t.eventName}</h3><span class="fee">${t.buyIn}å††</span></div>
            <div class="tournament-meta"><div><strong>åº—èˆ—</strong> ${t.storeName}</div><div><strong>æ—¥ä»˜</strong> ${t.startDate}</div></div>
            <div style="display: flex; gap: 8px; margin-top: 12px;">
              <button class="edit-btn" data-id="${d.id}" style="flex: 1;">ç·¨é›†</button>
              <button class="delete-btn" data-id="${d.id}" style="flex: 1;">å‰Šé™¤</button>
            </div>
          </div>`;
      }).join('');
      list.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if(confirm('ã“ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
            await deleteDoc(doc(db, "tournaments", btn.dataset.id));
            loadAllTournaments();
          }
        });
      });
      list.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const docId = btn.dataset.id;
          const docRef = doc(db, "tournaments", docId);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('editing-id').value = docId;
            document.getElementById('store-select').value = data.storeId || '';
            document.getElementById('event-name').value = data.eventName || '';
            document.getElementById('start-date').value = data.startDate || '';
            document.getElementById('start-time').value = data.startTime || '';
            document.getElementById('late-reg').value = data.lateReg || '';
            document.getElementById('event-type').value = data.eventType || 'ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ';
            document.getElementById('buy-in').value = data.buyIn || '';
            document.getElementById('reentry-fee').value = data.reentryFee || '';
            document.getElementById('addon').value = data.addon || '';
            document.getElementById('stack').value = data.stack || '';
            document.getElementById('prize').value = data.prize || '';
            document.getElementById('notes').value = data.notes || '';
            
            document.getElementById('form-title').textContent = 'ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆæƒ…å ±ä¿®æ­£';
            document.getElementById('submit-btn').textContent = 'æ›´æ–°ã™ã‚‹';
            document.getElementById('cancel-edit-btn').style.display = 'block';
            document.getElementById('form-title').scrollIntoView({ behavior: 'smooth' });
          }
        });
      });
    }


  </script>
</body>
</html>