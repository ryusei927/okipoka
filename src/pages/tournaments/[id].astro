---
import Analytics from '@vercel/analytics/astro'
import "../../styles/header_footer.css";
import "../../styles/mainstyle.css";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import AdSectionVIP_1 from "../../components/AdSectionVIP_1.astro";
import AdSectionVIP_2 from "../../components/AdSectionVIP_2.astro";

export const prerender = false;
import { initializeApp } from "firebase/app";
import { getFirestore, doc, getDoc } from "firebase/firestore";

const firebaseConfig = {
  apiKey: "AIzaSyBhItIbOxR6rXdClsDidrcB1iB1714paAs",
  authDomain: "okipoka-68419.firebaseapp.com",
  projectId: "okipoka-68419",
  storageBucket: "okipoka-68419.appspot.com",
  messagingSenderId: "749122576664",
  appId: "1:749122576664:web:20b93253162b185d993e6d",
  measurementId: "G-GN4PCM7BZB"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const { id } = Astro.params;
const docRef = doc(db, "tournaments", id as string);
const snap = await getDoc(docRef);
const data = snap.exists() ? snap.data() : null;

// FirestoreのusersコレクションからinstagramUrlを取得
let instagramUrl = "";
if (data?.postedBy) {
  const userRef = doc(db, "users", data.postedBy);
  const userSnap = await getDoc(userRef);
  if (userSnap.exists()) {
    const userData = userSnap.data();
    instagramUrl = userData.instagramUrl || "";
  }
}
---

<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>トーナメント詳細 | OKIPOKA</title>
    <style>
      .main-container {
        padding: 3rem 1.5rem;
        max-width: 900px;
        margin: 0 auto;
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
          Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      }

      h1.title {
        font-size: 2.4rem;
        margin-bottom: 2rem;
        border-bottom: 3px solid #ff7f00;
        padding-bottom: 0.75rem;
        color: #222;
        text-align: center;
        font-weight: 700;
        letter-spacing: 0.05em;
      }

      .section-label {
        font-size: 1.6rem;
        margin-top: 2.5rem;
        margin-bottom: 1rem;
        color: #ff7f00;
        border-left: 6px solid #ff7f00;
        padding-left: 0.75rem;
        font-weight: 600;
      }

      .tournament-item {
        background-color: #fafafa;
        border-radius: 10px;
        padding: 2rem 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        margin-bottom: 2.5rem;
        border-top: 1px solid #ddd;
      }

      .tournament-item p {
        font-size: 1.3rem;
        margin: 0.6rem 0;
        line-height: 1.75;
        color: #444;
        border-bottom: 1px solid #eee;
        padding-bottom: 0.5rem;
        display: flex;
        justify-content: start;
        align-items: center;
        gap: 0.5rem;
      }

      .tournament-item p strong {
        display: inline-block;
        width: 110px;
        color: #333;
        font-weight: 600;
      }

      .tournament-item a {
        color: #ff7f00;
        text-decoration: underline;
        font-weight: 600;
        transition: color 0.3s ease;
      }

      .tournament-item a:hover,
      .tournament-item a:focus {
        color: #cc6600;
      }

      .tournament-item a.button-link {
        display: inline-block;
        padding: 4px 10px;
        background-color: #eee;
        color: #333;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.95rem;
        transition: background-color 0.3s, color 0.3s;
      }
      .tournament-item a.button-link:hover {
        background-color: #ddd;
        color: #000;
      }

      .back-link {
        display: block;
        margin: 3rem auto 0;
        font-size: 1.2rem;
        color: #fff;
        text-align: center;
        text-decoration: none;
        background-color: #ff7f00;
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        transition: all 0.3s ease;
        width: fit-content;
      }

      .back-link:hover,
      .back-link:focus {
        background-color: #cc6600;
        box-shadow: 0 0 8px rgba(255, 127, 0, 0.5);
      }

      .event-name-highlight {
        background-color: #f9f9f9;
        padding: 1.2rem 2rem;
        border-left: 5px solid #999;
        border-radius: 8px;
        font-size: 1.8rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 2.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        text-align: center;
      }

      @media (max-width: 600px) {
        .main-container {
          padding: 2rem 1rem;
        }

        .tournament-item p strong {
          width: 90px;
          font-size: 1.1rem;
        }

        h1.title {
          font-size: 1.8rem;
          margin-bottom: 1.5rem;
        }

        .section-label {
          font-size: 1.3rem;
          margin-top: 2rem;
          margin-bottom: 0.8rem;
          padding-left: 0.6rem;
          border-left-width: 4px;
        }

        .event-name-highlight {
          font-size: 1.5rem;
          padding: 1rem;
        }
      }

      .event-name-highlight h2 {
        position: relative;
        display: inline-block;
        font-size: 2rem;
        padding-bottom: 0.5rem;
        margin-bottom: 0;
        font-weight: 700;
        color: #333;
        background: none;
        -webkit-text-fill-color: initial;
        -webkit-background-clip: initial;
      }

      .event-name-highlight h2::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 25%;
        width: 50%;
        height: 3px;
        background-color: #999;
        border-radius: 2px;
      }
    </style>
  </head>
  <body>
    <Header  />

    <main class="main-container">
      {data ? (
        <>
          <h1 class="title">トーナメント詳細</h1>

          <div class="event-name-highlight">
            <h2>{data.eventName}</h2>
          </div>

          <div class="tournament-item">
            <h2 class="section-label">基本情報</h2>
            <p><strong>会場：</strong>
              {instagramUrl
                ? <a href={instagramUrl} target="_blank" rel="noopener noreferrer">{data.storeName}</a>
                : data.storeName || data.postedBy || "未登録"}
            </p>
            <p><strong>日付：</strong>{data.startDate}</p>
            <p><strong>開始：</strong>{data.startTime}</p>
            <p><strong>締切：</strong>{data.lateReg || "未設定"}</p>
            <p><strong>種類：</strong>{data.eventType || "不明"}</p>
          </div>

          <div class="tournament-item">
            <h2 class="section-label">参加情報</h2>
            <p><strong>参加費：</strong>{data.buyIn} 円</p>
            <p><strong>アドオン：</strong>{data.addon}</p>
            <p><strong>スタック：</strong>{data.stack}</p>
            <p><strong>プライズ：</strong>{data.prize}</p>
          </div>

          <div class="tournament-item">
            <h2 class="section-label">その他</h2>
            <p><strong>URL：</strong>
              {data.structureUrl
                ? <>
                    <a href={data.structureUrl} target="_blank" rel="noopener noreferrer" class="button-link">ページを開く</a>
                    <span style="font-size: 0.85rem; color: #888; margin-left: 0.5rem;">
                      ({new URL(data.structureUrl).hostname})
                    </span>
                  </>
                : "なし"}
            </p>
            <p><strong>備考：</strong>{data.note || "なし"}</p>
          </div>

          <a href="/tournaments/tournaments" class="back-link">← 一覧へ戻る</a>
        </>
      ) : (
        <p>データが見つかりませんでした。</p>
      )}
    </main>
    <Footer  />
    <Analytics />
    <script src="/js/header.js" type="module"></script>
  </body>
</html>