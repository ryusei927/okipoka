---
import Footer from "../components/Footer.astro";
import Analytics from '@vercel/analytics/astro';
import "../styles/global.css";
import "../styles/footer.css";
import stores from "../data/stores.json";

// åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’JSONæ–‡å­—åˆ—ã¨ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã«æ¸¡ã™
const storesJson = JSON.stringify(stores);
---
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ãƒãƒƒãƒ—æ¤œç´¢ | OKIPOKA</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     
    <style>
        .map-page { max-width: 100%; height: 100vh; display: flex; flex-direction: column; }
        .map-header { padding: 1rem; background: #fff; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
        .map-header h1 { font-size: 1.5rem; margin: 0; }
        .map-container { flex: 1; width: 100%; position: relative; }
        #map { width: 100%; height: 100%; }
        
        .back-link {
            display: inline-block;
            margin-top: 0.5rem;
            color: var(--color-primary);
            font-weight: bold;
        }

        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.2);
        }
        .leaflet-popup-content {
            margin: 13px 19px;
            line-height: 1.4;
            text-align: center;
        }
        .store-popup h3 {
            margin: 0 0 5px 0;
            font-size: 1.1rem;
            color: #333;
        }
        .store-popup img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin: 0 auto 8px auto;
            border-radius: 50%;
            border: 1px solid #eee;
        }
        .store-popup a {
            display: inline-block;
            margin-top: 5px;
            padding: 4px 12px;
            background: var(--color-primary);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .store-popup a:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="map-page">
        <header class="map-header">
            <h1>ãƒãƒ¼ã‚«ãƒ¼ã‚¹ãƒãƒƒãƒˆãƒãƒƒãƒ—</h1>
            <a href="/" class="back-link">â† ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
        </header>
        
        <div class="map-container">
            <div id="map"></div>
        </div>
        
        <!-- ãƒ‡ãƒ¼ã‚¿ã‚’HTMLè¦ç´ ã«åŸ‹ã‚è¾¼ã‚€ -->
        <div id="map-data" data-stores={storesJson} style="display:none;"></div>
    </div>

    <!-- Leaflet JS -->
    <script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script is:inline>
        // åº—èˆ—ãƒ‡ãƒ¼ã‚¿å–å¾—
        const dataElement = document.getElementById('map-data');
        const stores = JSON.parse(dataElement.dataset.stores);

        // åœ°å›³ã®åˆæœŸåŒ– (æ²–ç¸„æœ¬å³¶ä¸­å¿ƒ)
        const map = L.map('map').setView([26.35, 127.8], 10);

        // åœ°å›³ã‚¿ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // å„åº—èˆ—ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
        stores.forEach(store => {
            if (store.lat && store.lng) {
                const marker = L.marker([store.lat, store.lng]).addTo(map);
                
                const popupContent = `
                    <div class="store-popup">
                        <img src="${store.logo}" alt="${store.name}">
                        <h3>${store.name}</h3>
                        <p>ã‚¨ãƒªã‚¢: ${store.area}</p>
                        <a href="/stores/${store.id}">è©³ç´°ã‚’è¦‹ã‚‹</a>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
            }
        });

        // ç¾åœ¨åœ°å–å¾—ãƒœã‚¿ãƒ³ã®è¿½åŠ  (ç°¡æ˜“å®Ÿè£…)
        const locateControl = L.Control.extend({
            options: {
                position: 'topleft'
            },
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                container.style.backgroundColor = 'white';
                container.style.width = '34px';
                container.style.height = '34px';
                container.style.cursor = 'pointer';
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.style.justifyContent = 'center';
                container.title = "ç¾åœ¨åœ°ã‚’è¡¨ç¤º";
                
                container.innerHTML = '<span style="font-size:20px;">ğŸ“</span>';
                
                container.onclick = function(e){
                    e.preventDefault();
                    e.stopPropagation();
                    map.locate({setView: true, maxZoom: 13});
                }
                return container;
            }
        });
        map.addControl(new locateControl());

        // ç¾åœ¨åœ°ãŒè¦‹ã¤ã‹ã£ãŸæ™‚ã®å‡¦ç†
        map.on('locationfound', function(e) {
            L.circle(e.latlng, {
                radius: e.accuracy / 2,
                color: '#4285F4',
                fillColor: '#4285F4',
                fillOpacity: 0.2
            }).addTo(map);
            
            L.marker(e.latlng).addTo(map)
                .bindPopup("ç¾åœ¨åœ°").openPopup();
        });

        // ã‚¨ãƒ©ãƒ¼å‡¦ç†
        map.on('locationerror', function(e) {
            alert("ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
        });

    </script>
    <Analytics />
</body>
</html>
