---
// src/pages/stores/[id].astro

// ★★★ 修正点: サーバーサイドでFirebaseからデータを取得 ★★★
import { initializeApp, getApp, getApps } from "firebase/app";
import { getFirestore, doc, getDoc } from "firebase/firestore";

import Analytics from '@vercel/analytics/astro';
import Footer from '../../components/Footer.astro';
import "../../styles/footer.css";
import '../../styles/stores.css';

const { id } = Astro.params;

// Firebaseプロジェクト設定をv2に更新
const firebaseConfig = {
  apiKey: "AIzaSyB8q6HLBGi_DWmrvkGCaWK_B6EeP7D--wo",
  authDomain: "okipoka-v2.firebaseapp.com",
  projectId: "okipoka-v2",
  storageBucket: "okipoka-v2.firebasestorage.app",
  messagingSenderId: "6256473895",
  appId: "1:6256473895:web:df644eaac108a218d59b02",
  measurementId: "G-JLC2569WN3"
};

const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
const db = getFirestore(app);

const docRef = doc(db, "stores", id as string);
const docSnap = await getDoc(docRef);
const store = docSnap.exists() ? docSnap.data() : null;

const pageTitle = store ? `OKIPOKA | ${store.name}` : "OKIPOKA | 店舗情報";
---

<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{pageTitle}</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <style>
    .store-name { font-size: 2.2rem; margin-top: 1.5rem; }
    .store-catchphrase { font-size: 1.1rem; color: #666; margin-top: -1rem; }
    .store-intro { margin: 2rem 0; padding: 1.5rem; background: #f9f9f9; border-radius: 8px; }
  </style>
</head>

<body>
  <main>
    {store ? (
      <section class="store-detail">
        <div class="store-header">
          {store.logoUrl && <img src={store.logoUrl} alt={`${store.name} Logo`} class="store-image" />}
          <h2 class="store-name">{store.name || ''}</h2>
          {store.catchphrase && <p class="store-catchphrase">{store.catchphrase}</p>}
        </div>

        {store.description && (
          <div class="store-intro" set:html={store.description.replace(/\\n/g, '<br>')} />
        )}

        <div class="store-section">
          <h2>店舗情報</h2>
          <dl>
            {store.name && <><dt>店舗名</dt><dd>{store.name}</dd></>}
            {store.address && <><dt>所在地</dt><dd>{store.address}</dd></>}
            {store.hours && <><dt>営業時間</dt><dd>{store.hours}</dd></>}
          </dl>
        </div>

        <div class="store-section">
          <h2>関連リンク</h2>
          <ul>
            {store.instagramUrl && <li><a href={store.instagramUrl} target="_blank" rel="noopener noreferrer"><img src="/images/insta.png" class="icon" alt="Instagram" /> 公式Instagram</a></li>}
            {store.x_twitterUrl && <li><a href={store.x_twitterUrl} target="_blank" rel="noopener noreferrer">公式 X (Twitter)</a></li>}
            {store.googleMapUrl && <li><a href={store.googleMapUrl} target="_blank" rel="noopener noreferrer">Googleマップで見る</a></li>}
            {store.websiteUrl && <li><a href={store.websiteUrl} target="_blank" rel="noopener noreferrer">公式サイト</a></li>}
          </ul>
        </div>
      </section>
    ) : (
      <section class="store-detail">
        <h2>店舗情報が見つかりませんでした。</h2>
      </section>
    )}
  </main>
  <Footer />
  <Analytics />
</body>
</html>