---
import "../styles/global.css";
import "../styles/footer.css";
import Analytics from "@vercel/analytics/astro";
import StoreList from "../components/StoreList.astro";
import AdBanner from "../components/AdBanner.astro"; 
import AdSquare from "../components/AdSquare.astro";
import AnnouncementBanner from "../components/AnnouncementBanner.astro";
import Footer from "../components/Footer.astro";

---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OKIPOKA | 沖縄ポーカー情報ポータル</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />

    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#ff7f00" />
    
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="OKIPOKA" />
    <link rel="apple-touch-icon" href="/images/logo-192x192.png" />
    
    <style>
      .hero { position: relative; background-image: url("/images/image1.png"); background-size: cover; background-position: center; border-bottom: 1px solid var(--color-border); height: 180px; }
      @media (min-width: 768px) { .hero { height: 460px; } }
      @media (min-width: 1024px) { .hero { height: 590px; } }
      .section-title { text-align: center; margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 800; color: #333; }
      .date-picker-wrapper { text-align: center; margin: 2rem auto 1.5rem auto; padding: 1rem; background-color: var(--color-surface); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); max-width: 400px; }
      #datePicker { padding: 0.5rem; border-radius: 4px; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); font-size: 1rem; }
      .container { max-width: 900px; }
      #tournament-list { display: grid; gap: 0.8rem; }
      
      /* PWAプロンプトバナーのスタイル */
      .pwa-prompt-container {
        text-align: center;
        background-color: #e6f7ff; /* 明るい青の背景 */
        border: 1px solid #91d5ff;
        border-radius: 8px;
        padding: 1.5rem;
        margin: 2rem auto;
        max-width: 900px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: all 0.3s ease;
        display: none; /* デフォルトで非表示 */
      }
      .pwa-prompt-container:hover {
        background-color: #d6f7ff;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      }
      .pwa-prompt-container.show {
        display: block;
      }
      .pwa-prompt-container p {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1890ff;
        margin: 0;
      }
      .pwa-prompt-container strong {
        color: #096dd9;
      }
      .install-button {
        background-color: #1890ff;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 1rem;
      }
      .install-button:hover {
        background-color: #096dd9;
        transform: translateY(-1px);
      }
      @media (max-width: 768px) {
        .pwa-prompt-container {
          padding: 1rem;
          margin: 1.5rem 1rem;
        }
        .pwa-prompt-container p {
          font-size: 1rem;
        }
        .install-button {
          padding: 0.6rem 1.2rem;
          font-size: 0.9rem;
        }
      }
      
      /* ブログバナーのスタイル */
      .blog-banner-link {
        display: block;
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        text-decoration: none;
        color: inherit;
      }
      
      .blog-banner-link:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      }
      
      .blog-banner {
        width: 100%;
        height: auto;
        display: block;
        transition: transform 0.3s ease;
      }
      
      .blog-banner-link:hover .blog-banner {
        transform: scale(1.05);
      }
      
      .blog-banner-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0,0,0,0.7));
        color: white;
        padding: 2rem 1.5rem 1.5rem 1.5rem;
        text-align: left;
        transition: all 0.3s ease;
      }
      
      .blog-banner-overlay h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      }
      
      .blog-banner-overlay p {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        opacity: 0.9;
        transition: opacity 0.3s ease;
      }
      
      .blog-banner-link:hover .blog-banner-overlay p {
        opacity: 1;
      }
      
      /* レスポンシブ対応 */
      @media (max-width: 768px) {
        .blog-banner-overlay {
          padding: 1.5rem 1rem 1rem 1rem;
        }
        
        .blog-banner-overlay h3 {
          font-size: 1.2rem;
        }
        
        .blog-banner-overlay p {
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <main>

      <section class="hero"></section>

      <AdBanner />
      
      <div class="container">
          <button id="install-button" class="install-button">
            アプリとしてインストール
          </button>
        </section>
      </div>
      
      <div class="container">
        <section id="tournaments-today">
          <h2 class="section-title">トーナメント情報</h2>
          <div class="date-picker-wrapper">
            <label for="datePicker" style="font-weight: bold; margin-right: 0.5em;">表示日を選択：</label>
            <input type="date" id="datePicker" />
          </div>
          <div id="tournament-list">
            <p style="text-align:center;">トーナメント情報を読み込んでいます...</p>
          </div>
        </section>
        <AdSquare />
        <section id="blog-section" style="margin-top: 4rem;">
          <h2 class="section-title">ブログ</h2>
          <a href="/blog" class="blog-banner-link">
            <img src="/images/blog_banner.png" alt="OKIPOKA Blog - ポーカー戦略・理論・最新情報" class="blog-banner" />
            <div class="blog-banner-overlay">
              <h3>ポーカー戦略・理論・最新情報</h3>
              <p>記事を読む →</p>
            </div>
          </a>
        </section>
        
        <section id="stores-list" style="margin-top: 4rem;">
          <h2 class="section-title">店舗一覧</h2>
          <StoreList />
        </section>
      </div>
      <AdBanner />
    </main>
    <Footer />
    <Analytics />

    <script type="module" src="/js/tournaments.js"></script>
    
    <script is:inline>
      // PWAインストール機能
      (function() {
        let deferredPrompt = null;
        const pwaPrompt = document.getElementById('pwa-prompt');
        const installButton = document.getElementById('install-button');

        // beforeinstallpromptイベントをキャッチ
        window.addEventListener('beforeinstallprompt', function(e) {
          // デフォルトのミニインフォバーを非表示
          e.preventDefault();
          // イベントを保存
          deferredPrompt = e;
          // カスタムプロンプトを表示
          if (pwaPrompt) {
            pwaPrompt.classList.add('show');
          }
        });

        // インストールボタンのクリックイベント
        if (installButton) {
          installButton.addEventListener('click', function() {
            if (!deferredPrompt) {
              return;
            }

            // インストールプロンプトを表示
            deferredPrompt.prompt();
            
            // ユーザーの選択を取得
            deferredPrompt.userChoice.then(function(choiceResult) {
              if (choiceResult.outcome === 'accepted') {
                console.log('ユーザーがPWAインストールを承認しました');
              } else {
                console.log('ユーザーがPWAインストールを拒否しました');
              }
              
              // プロンプトを非表示
              if (pwaPrompt) {
                pwaPrompt.classList.remove('show');
              }
              deferredPrompt = null;
            });
          });
        }

        // アプリがインストール済みの場合はプロンプトを非表示
        window.addEventListener('appinstalled', function() {
          if (pwaPrompt) {
            pwaPrompt.classList.remove('show');
          }
          deferredPrompt = null;
        });

        // iOSのSafariの場合の特別処理
        function isIOS() {
          return /iPad|iPhone|iPod/.test(navigator.userAgent);
        }

        function isInStandaloneMode() {
          return window.matchMedia('(display-mode: standalone)').matches;
        }

        // iOSでスタンドアロンモードでない場合にカスタムメッセージを表示
        if (isIOS() && !isInStandaloneMode()) {
          setTimeout(function() {
            if (pwaPrompt) {
              pwaPrompt.classList.add('show');
              pwaPrompt.innerHTML = '<p>このサイトを<strong>ホーム画面に追加</strong>できます 📲</p><p style="font-size: 0.9rem; margin-top: 0.5rem; color: #666;">Safari の「共有」→「ホーム画面に追加」をタップしてください</p>';
            }
          }, 2000);
        }
      })();
    </script>
  </body>
</html>